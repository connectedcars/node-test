import https from 'https'

import { HttpIncomingMessage, HttpRequestListener } from './http-common'
import { HttpServerBase } from './http-server-base'

const localhostCertificate = `-----BEGIN CERTIFICATE-----
MIIC/DCCAeQCCQCaq+pPRSkopTANBgkqhkiG9w0BAQsFADBAMQswCQYDVQQGEwJE
SzESMBAGA1UEAwwJbG9jYWxob3N0MR0wGwYJKoZIhvcNAQkBFg50ZXN0QGxvY2Fs
aG9zdDAeFw0xODAxMjEyMDU3MzJaFw0yODAxMTkyMDU3MzJaMEAxCzAJBgNVBAYT
AkRLMRIwEAYDVQQDDAlsb2NhbGhvc3QxHTAbBgkqhkiG9w0BCQEWDnRlc3RAbG9j
YWxob3N0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApdWZLLnAr0jR
t7KGQKj51/GbBDjIN16I/O4ZlJHxrzOnkoxOrSm+mkh+hTLxEKwsCzPclP/MTg4S
pFsyyhiF8sBfopB/KMmQ1OoT65cG0mZTCv9cv49STvQ2bkEfCdvUWQNp9YX5HBNq
RUlgAQM/AW9uetjhX+aJK0Ot6C5Nnp2rOX7FlW5ruZ64cRjr4pAxVjWI1B0h/Sa1
RPXaOUrVoEaVrZ7I6HO6HVeQVeAgSe0y9b9gtrqx9YxQEdo2lQR8z90ttC7uATDO
WgH5pJ7GWt7utfJksZFcZ/EdTRp10kNqlALZnrEtSNRD47mRloybZ39aBfzIKdUl
i4CeDgnhoQIDAQABMA0GCSqGSIb3DQEBCwUAA4IBAQBsEY0g2JIBmsW6EYVyTqN9
IlBgG0eT//I17/wgvZ6X+8iHK/vk9uIn1qqu7MfBVw9ZHwpA0JA86YCyeEBsh8OD
UxlQA3+ovGpjv39iBfof+MbzQ3QjOvMPuykqbilm/dA9f0tXT6nKOQ7fS6uS6Q5v
EHtkHk+8t1IMAW2NpOfMphGMeAofko5jNTzqyGVMHK1ts6bmkq2iCv+BFJZip5EU
8SIxuHF5v/WAPaS1cl8DGsUxYDIWuIXhZVkmHYDux6TMyV9HtAEmvhm9Hh86ayi0
ZP60ZUsPY4r3yAn0b2PvY1wmYGOgeWnBdHx593/gsUthBYoMRVPv4OTqClJTqMGk
-----END CERTIFICATE-----`

const localhostKey = `-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCl1ZksucCvSNG3
soZAqPnX8ZsEOMg3Xoj87hmUkfGvM6eSjE6tKb6aSH6FMvEQrCwLM9yU/8xODhKk
WzLKGIXywF+ikH8oyZDU6hPrlwbSZlMK/1y/j1JO9DZuQR8J29RZA2n1hfkcE2pF
SWABAz8Bb2562OFf5okrQ63oLk2enas5fsWVbmu5nrhxGOvikDFWNYjUHSH9JrVE
9do5StWgRpWtnsjoc7odV5BV4CBJ7TL1v2C2urH1jFAR2jaVBHzP3S20Lu4BMM5a
AfmknsZa3u618mSxkVxn8R1NGnXSQ2qUAtmesS1I1EPjuZGWjJtnf1oF/Mgp1SWL
gJ4OCeGhAgMBAAECggEAKTXBUMoARg7Ufs/QaPUU0ULrAMuThZ7qb+BDXxY9dwph
FBvl2UZMZU6qkjMskLYYY9hJcoV2odcBbvJy1qHtd3uyyFUcJGiioyZgOOVY/qQK
8uqug7P8Aj7R3+gy7GJCjLQ6epcGZqG0gO9Q+i9yUsr8K28F4q0JXUT+THplM4sY
f8BRyuU5WiNESY2Z/wxdO+n2nbl1OAZ6vZZsxpSsPHdO71HT/evaOKXq6/pw8+gk
zSmSNXFUhSKJnlcz20w7vDCsBJug0GtW/Sbucyws757tX6oQ5tqpskn3lxzuYfdv
baZfd0z+GYwzEeb8hXAGkGjnPLu4mvsW/rfmX5bFoQKBgQDO+Goq8VTd/bVnNJl7
eftA+2aOh0zq20HNu5EQuCNuQPd7G2WycWNq+cI2PGXcCa1A6Uy2e3ppUCane5ri
6yUZwZNb2Dtjhno+RQ2OHWiNsVRM7niHpsknskRREJrnlICbWkbwYUCSAa3Q758j
4T1FezCJ+020saG2nIqzwH4gvQKBgQDNHoRnqS1C6+hWCJBcHuqyiwwNs8WTELvV
laLfHjogxqcr0h/ioLCsH/dBvJaT4MlhqiKiMuVVh0NI8EXk7k/TGCdMKhyjuS2Y
uDa6p/XdrwubSy3GRDnonVjkPO4hk8dAcsQJN7X/7x50ParZKCT9EoNyDDWUElCj
wJtbRJFstQKBgQDBmV7+EkZXbLXd9zbGaIDc9Qymr+sEGNpBznzQjd4eiMi2MBd9
xlC/xSakwvRo0ehtOo3WeEQ19JJjwdxM/LX0lLz5gZdz7lu0mbUnRV0ChWicmcjG
4v1wk3ER/x1XF/MA3n5S5jWXHdjwAuTylANTVfs+ZoL2Td49ycp4f8u7ZQKBgAsO
wxqHfz4lU5AXxBiDPinD3zF56IPGGiood/BJQ97ydp6hJEDmYr/UtVKg5QkxzAls
z5Mo5T4YHaN3+Hyf8EO0AKJVftfAqtmZzLGBTnrV7e1AP0Z59Rk6Kkmbk0bSHaK2
zSSmETSr4ltn26b7SAswjU9/ov/JgPli770a1DAlAoGAdWqRDR9bgy48FpiqV4CG
YGxOcQftDc/sgWncAqVPdm+LrV0hBKGLB+MZeLaPqmYXy16v7q5YWWwGwAabbFRg
tf3PO/1A+cD/vOd4Kcg98uIIgmMdVxCZaBjzsRb1wp9AKTWIMCvBEii9XmXGkXi2
eG8Nor88jMLTDJoCfYWy+So=
-----END PRIVATE KEY-----
`

const clientCaCertificate = `
-----BEGIN CERTIFICATE-----
MIICxDCCAawCCQDANCG9qwmP9jANBgkqhkiG9w0BAQsFADAkMQswCQYDVQQGEwJE
SzEVMBMGA1UEAwwMY2EubG9jYWxob3N0MB4XDTIwMDIxMDEzMzEzNFoXDTQ3MDYy
NzEzMzEzNFowJDELMAkGA1UEBhMCREsxFTATBgNVBAMMDGNhLmxvY2FsaG9zdDCC
ASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALBXAvHl0TEc/ANKrFNy1N1j
M0TgJTAr2Kpr6WcfPdDHRU3TfLnxKVCvX5zeY/2ePaCwWLqpk5HEcbOGu13hzVEG
hiBuKv4fpHZSzUcSmjK1FbMZ97OB50+3UgdIr50RUYeoiOnJ9MdVBiYsvIHGkh7A
ElWwRseYW0YdkvedXL3vkUwyGMgy89ds5bdNH5S9GBF40FGOd9EO9VfjHOjgT8AD
E5pYU3YzHvUkr+n7WV1PMKcyAj6PKgArn2HlAa8pbJDSq69PuIQDbdrwed+/qvtH
df2Bh/mdvz82rHn+A1nyN6uk/N8sQIFx9at5r5Pp0gpFDmCSlTciMwPQUDJBf3sC
AwEAATANBgkqhkiG9w0BAQsFAAOCAQEAl2vSjmu0ci5IAHS4G12Nr/UII7S/GO5k
iJGk4ibVFBOU6rnDFkDWEbwJbVPL36M99pb0Hb2SsXlLeEFRNeiH+gp9t/l8rqZ4
5dbFgio1QYrjj06ky/k9KFsEsAMcGejqTlcdTusKr6jIjUFvO43jT19G5lS5x9ZB
D8VZM3Uu8ROKW1GZ94TK+d4X8zjVb5Zm6XbKlcr02bb1vqylfrDXr26+EzeoiVS+
vEXV3BmGcPUwhc3sqJPVGFJP+oQ1sCOcGSLGcObjKMxkW/nBlM4NWIEgIXf/tWSA
u7l1KsCkQNS18HCjg555PI0CbaUQCl/ky7wIELtxIVGDwuNjXQ3j/A==
-----END CERTIFICATE-----`

const clientCertificate = `
-----BEGIN CERTIFICATE-----
MIIDwTCCAqkCCQCvT9HEoWZaOTANBgkqhkiG9w0BAQUFADAkMQswCQYDVQQGEwJE
SzEVMBMGA1UEAwwMY2EubG9jYWxob3N0MB4XDTIwMDIxMDEzMzI0MFoXDTQ3MDYy
NzEzMzI0MFowITELMAkGA1UEBhMCREsxEjAQBgNVBAMMCWxvY2FsaG9zdDCCAiIw
DQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBANpCashdgYlZISNyru1EIZ8HxUtp
YYSFrnzKgjDdTUzn9KSe42b+Mv5x6ZT/8D2FEuiVYnAVrYq4hVXD3bi/WKhGI4tp
dWk61J+NqNwYjIaS661rx26Q2q08mm3vgKQQQzaQsp3ceiKtFO+kpitBFGBjrtqI
PJGm+7v0G+ndaICYXcnVj0pKXbY1K7jM69xjiHR77AkFR4c5iOrkncjjLAKsTkFd
+n2g+iYBltEq81KvWNuv5Y5/AuzopV3ROFvdI5y/Wzal9pWyKI9KqC7bbcJA45D2
ATSKUWeGmPjDW7uSXHScqljXdtu41L9c6IanLK8o4XKLCFejtvFqZNgOPrA/j7G6
S8aHgSKTrm6WvNSPLCfkECWo/Cu6ZBFBWWotCXmv5WWJi5xq0Yga0z+9nVWGk70G
mwaD7yLfMZtg2ui7mjSzkCPyjREVQt1ffmcTbYNM0vWPJB6gcf+INGOv24pbch/I
K+6zfuc5eptASGDgwxJ3h2BtufeGQ4YXD3vLAB+6ysgLrB36mtVlWjLnM9/gIi5U
dZsk5ZIfuDtfQ6maOIQpV1f7h8QL9IC3UlXnH8BGk5TTaSvf0A1tyETfqIMqiZIp
eKjpo9+ZppAH134I2B42tQGImk3tzDiMNbUK9JezTtF2HMovVRtTVtTfKFpJ5Mir
h04N43PlVj2UGZjvAgMBAAEwDQYJKoZIhvcNAQEFBQADggEBACTWyJ/4QICEWJZc
+2D43RIYUBFy1gMhh/ZgU99vXZ4u2b/md8Jdgv+cAXhHUKOBM+SL95DyK9N2ydXU
jzmu4j47RM7Lfph/uA1fdjRi/h7uiVRLVnHdo0T2B6nxDP6qS1uHRuos1sSEkTgd
xRXgK5qaifOYPNjwMxqW2RZkx8Aby9wjMiBgiRnOGRuFbWWt+s62/xVZhKoMY1mn
VEWCZhSuvE49j1dIPAAuyNz01u0Skvzy8oYIj3BcproL9XhfBvgrsoGHDt5v0Y1I
U3AhxLThOdrz3oqDM6L27tHJ8bh/pP/3uG/gvHnueI0Cyitybo0gYLov3p8oRO4T
TCeS8cg=
-----END CERTIFICATE-----`

const clientKey = `-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----`

export type HttpsServerOptions = https.ServerOptions

export class HttpsServer extends HttpServerBase<https.Server> {
  public cert: HttpsServerOptions['cert']
  public key: HttpsServerOptions['key']
  public caAgent: https.Agent
  public clientCertAgent: https.Agent

  constructor(options: HttpsServerOptions, requestListener: HttpRequestListener) {
    options.cert
    options = {
      cert: localhostCertificate,
      key: localhostKey,
      ca: clientCaCertificate,
      requestCert: true,
      rejectUnauthorized: false, // so we can do own error handling
      ...options
    }
    super(
      'https://localhost',
      https.createServer(options, (req, res) => {
        this.handleRequest(req as HttpIncomingMessage, res, requestListener)
      })
    )
    this.cert = options.cert
    this.key = options.key
    this.caAgent = new https.Agent({
      ca: options.cert
    })
    this.clientCertAgent = new https.Agent({
      ca: options.cert,
      key: clientKey,
      cert: clientCertificate
    })
  }
}
