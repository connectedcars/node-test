/* eslint-disable @typescript-eslint/camelcase */
import { auditCheck } from './audit'
import { auditMultiVuln, auditNoVuln } from './resources/audit-help-text'

describe('checks/audit', () => {
  it('converts successful audit', () => {
    const data = JSON.parse(auditNoVuln)
    const result = auditCheck({
      data
    })
    expect(result).toStrictEqual({
      conclusion: 'success',
      output: {
        title: 'npm audit security report',
        summary: 'Found **0** vulnerabilities in 4982 scanned packages',
        text: ''
      }
    })
  })

  it('converts failed audit', () => {
    const data = JSON.parse(auditMultiVuln)
    const result = auditCheck({
      data
    })
    expect(result).toStrictEqual({
      conclusion: 'neutral',
      output: {
        title: 'npm audit security report',
        summary:
          'Found **32** vulnerabilities (**23** low, **6** moderate, **2** high, **1** critical) in 965 scanned packages',
        text:
          "## Critical: Command Injection\nAffected versions of `growl` do not properly sanitize input prior to passing it into a shell command, allowing for arbitrary command execution.\n\n[Read about advisory 146 at nodesecurity.io](https://nodesecurity.io/advisories/146)\n\n#### growl (<1.10.2)\n - **DEV:** `mocha` > `growl`\n\n#### Recommendation\nUpdate to version 1.10.2 or later.\n\n## High: Regular Expression Denial of Service\nAffected versions of `tough-cookie` are susceptible to a regular expression denial of service.\n\nThe amplification on this vulnerability is relatively low - it takes around 2 seconds for the engine to execute on a malicious input which is 50,000 characters in length.\n\nIf node was compiled using the `-DHTTP_MAX_HEADER_SIZE` however, the impact of the vulnerability can be significant, as the primary limitation for the vulnerability is the default max HTTP header length in node.\n\n[Read about advisory 525 at nodesecurity.io](https://nodesecurity.io/advisories/525)\n\n#### tough-cookie (<2.3.3)\n - **DEV:** `coveralls` > `request` > `tough-cookie`\n\n#### Recommendation\nUpdate to version 2.3.3 or later.\n\n## High: Regular Expression Denial of Service\nVersions of `sshpk` before 1.14.1 are vulnerable to regular expression denial of service when parsing crafted invalid public keys.\n\n[Read about advisory 606 at nodesecurity.io](https://nodesecurity.io/advisories/606)\n\n#### sshpk (<1.14.1)\n - **DEV:** `coveralls` > `request` > `http-signature` > `sshpk`\n\n#### Recommendation\nUpdate to version 1.14.1 or later.\n\n## Moderate: Prototype pollution\nVersions of `hoek` prior to 4.2.1 and 5.0.3 are vulnerable to prototype pollution.\n\nThe `merge` function, and the `applyToDefaults` and `applyToDefaultsWithShallow` functions which leverage `merge` behind the scenes, are vulnerable to a prototype pollution attack when provided an _unvalidated_ payload created from a JSON string containing the `__proto__` property.\n\nThis can be demonstrated like so:\n\n```javascript\nvar Hoek = require('hoek');\nvar malicious_payload = '{\"__proto__\":{\"oops\":\"It works !\"}}';\n\nvar a = {};\nconsole.log(\"Before : \" + a.oops);\nHoek.merge({}, JSON.parse(malicious_payload));\nconsole.log(\"After : \" + a.oops);\n```\n\nThis type of attack can be used to overwrite existing properties causing a potential denial of service.\n\n[Read about advisory 566 at nodesecurity.io](https://nodesecurity.io/advisories/566)\n\n#### hoek (<= 4.2.0 || >= 5.0.0 < 5.0.3)\n - **DEV:** `coveralls` > `request` > `hawk` > `boom` > `hoek`\n - **DEV:** `coveralls` > `request` > `hawk` > `cryptiles` > `boom` > `hoek`\n - **DEV:** `coveralls` > `request` > `hawk` > `hoek`\n - **DEV:** `coveralls` > `request` > `hawk` > `sntp` > `hoek`\n\n#### Recommendation\nUpdate to version 4.2.1, 5.0.3 or later.\n\n## Moderate: Memory Exposure\nVersions of `tunnel-agent` before 0.6.0 are vulnerable to memory exposure.\n\nThis is exploitable if user supplied input is provided to the auth value and is a number.\n\nProof-of-concept:\n```js\nrequire('request')({\n  method: 'GET',\n  uri: 'http://www.example.com',\n  tunnel: true,\n  proxy:{\n    protocol: 'http:',\n    host:'127.0.0.1',\n    port:8080,\n    auth:USERSUPPLIEDINPUT // number\n  }\n});\n```\n\n[Read about advisory 598 at nodesecurity.io](https://nodesecurity.io/advisories/598)\n\n#### tunnel-agent (<0.6.0)\n - **DEV:** `coveralls` > `request` > `tunnel-agent`\n\n#### Recommendation\nUpdate to version 0.6.0 or later.\n\n## Moderate: Out-of-bounds Read\nAll versions of `stringstream` are vulnerable to out-of-bounds read as it allocates uninitialized Buffers when number is passed in input stream on Node.js 4.x and below.\n\n[Read about advisory 664 at nodesecurity.io](https://nodesecurity.io/advisories/664)\n\n#### stringstream (<=0.0.5)\n - **DEV:** `coveralls` > `request` > `stringstream`\n\n#### Recommendation\nNo fix is currently available for this vulnerability. It is our recommendation to not install or use this module if user input is being passed in to `stringstream`.\n\n\n## Low: Cryptographically Weak PRNG\nAffected versions of `randomatic` generate random values using a cryptographically weak psuedo-random number generator. This may result in predictable values instead of random values as intended.\n\n\n\n[Read about advisory 157 at nodesecurity.io](https://nodesecurity.io/advisories/157)\n\n#### randomatic (<3.0.0)\n - **DEV:** `nyc` > `micromatch` > `braces` > `expand-range` > `fill-range` > `randomatic`\n - **DEV:** `nyc` > `test-exclude` > `micromatch` > `braces` > `expand-range` > `fill-range` > `randomatic`\n\n#### Recommendation\nUpdate to version 3.0.0 or later.\n\n\n## Low: Regular Expression Denial of Service\nAffected versions of `debug` are vulnerable to regular expression denial of service when untrusted user input is passed into the `o` formatter. \n\nAs it takes 50,000 characters to block the event loop for 2 seconds, this issue is a low severity issue.\n\n[Read about advisory 534 at nodesecurity.io](https://nodesecurity.io/advisories/534)\n\n#### debug (<= 2.6.8 || >= 3.0.0 <= 3.0.1)\n - **DEV:** `babel-eslint` > `babel-traverse` > `debug`\n - **DEV:** `eslint` > `debug`\n - **DEV:** `mocha` > `debug`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-template` > `babel-traverse` > `debug`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-traverse` > `debug`\n - **DEV:** `nyc` > `istanbul-lib-source-maps` > `debug`\n\n#### Recommendation\nVersion 2.x.x: Update to version 2.6.9 or later.\nVersion 3.x.x: Update to version 3.1.0 or later.\n\n\n## Low: Prototype Pollution\nVersions of `lodash` before 4.17.5 are vulnerable to prototype pollution. \n\nThe vulnerable functions are 'defaultsDeep', 'merge', and 'mergeWith' which allow a malicious user to modify the prototype of `Object` via `__proto__` causing the addition or modification of an existing property that will exist on all objects.\n\n\n\n[Read about advisory 577 at nodesecurity.io](https://nodesecurity.io/advisories/577)\n\n#### lodash (<4.17.5)\n - **DEV:** `babel-eslint` > `babel-traverse` > `babel-types` > `lodash`\n - **DEV:** `babel-eslint` > `babel-traverse` > `lodash`\n - **DEV:** `babel-eslint` > `babel-types` > `lodash`\n - **DEV:** `eslint` > `inquirer` > `lodash`\n - **DEV:** `eslint` > `lodash`\n - **DEV:** `eslint` > `table` > `lodash`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-generator` > `babel-types` > `lodash`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-generator` > `lodash`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-template` > `babel-traverse` > `babel-types` > `lodash`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-template` > `babel-traverse` > `lodash`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-template` > `babel-types` > `lodash`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-template` > `lodash`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-traverse` > `babel-types` > `lodash`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-traverse` > `lodash`\n - **DEV:** `nyc` > `istanbul-lib-instrument` > `babel-types` > `lodash`\n\n#### Recommendation\nUpdate to version 4.17.5 or later."
      }
    })
  })
})
